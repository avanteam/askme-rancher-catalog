# Job pour synchroniser les secrets globaux depuis askme-platform
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "askme.fullname" . }}-sync-global-secrets-{{ .Chart.Version | replace "." "-" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    app.kubernetes.io/component: secret-sync
  annotations:
    askme.avanteam.com/job-type: "secret-sync"
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "askme.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: secret-sync
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "askme.fullname" . }}-dns-manager
      containers:
      - name: secret-sync
        image: alpine/k8s:1.30.0
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "ðŸ” Synchronisation secrets globaux cross-namespace..."
          echo "ðŸ“‹ Source namespace: askme-platform"
          echo "ðŸŽ¯ Destination namespace: {{ .Release.Namespace }}"
          
          # Fonction pour fusionner les secrets (valeurs locales prioritaires)
          merge_secrets() {
            local source_secret="$1"
            local target_secret="$2"
            local optional="$3"

            echo "ðŸ” Verification du secret source: $source_secret"
            if ! kubectl get secret "$source_secret" -n askme-platform >/dev/null 2>&1; then
              if [ "$optional" = "true" ]; then
                echo "âš ï¸  Secret $source_secret non trouve (optionnel) - ignore"
                return 0
              else
                echo "âŒ ERREUR: Secret requis $source_secret non trouve dans askme-platform"
                exit 1
              fi
            fi

            echo "âœ… Secret global $source_secret trouve"

            # Verifier si le secret local existe
            if ! kubectl get secret "$target_secret" -n "{{ .Release.Namespace }}" >/dev/null 2>&1; then
              echo "ðŸ†• Pas de secret local - copie complete du secret global..."
              kubectl get secret "$source_secret" -n askme-platform -o json | \
                jq --arg name "$target_secret" --arg namespace "{{ .Release.Namespace }}" \
                   '.metadata = {"name": $name, "namespace": $namespace, "annotations": {"helm.sh/resource-policy": "keep"}, "labels": {}}' | \
                kubectl apply -f -
              echo "âœ… Secret $target_secret cree depuis le secret global"
              return 0
            fi

            echo "ðŸ”„ Fusion du secret local avec les valeurs globales..."

            # Recuperer les donnees des deux secrets
            global_data=$(kubectl get secret "$source_secret" -n askme-platform -o jsonpath='{.data}')
            local_data=$(kubectl get secret "$target_secret" -n "{{ .Release.Namespace }}" -o jsonpath='{.data}')

            # Compter les cles
            global_keys=$(echo "$global_data" | jq 'keys | length')
            local_keys=$(echo "$local_data" | jq 'keys | length')
            echo "ðŸ“Š Cles globales: $global_keys | Cles locales: $local_keys"

            # Fusionner: global d'abord, puis local ecrase (priorite au local)
            merged_data=$(echo "$global_data $local_data" | jq -s '.[0] * .[1]')
            merged_keys=$(echo "$merged_data" | jq 'keys | length')
            echo "ðŸ“¦ Cles apres fusion: $merged_keys"

            # Appliquer le secret fusionne
            kubectl get secret "$target_secret" -n "{{ .Release.Namespace }}" -o json | \
              jq --argjson merged "$merged_data" \
                 '.data = $merged | .metadata.annotations["helm.sh/resource-policy"] = "keep"' | \
              kubectl apply -f -

            echo "âœ… Secret $target_secret fusionne (valeurs locales preservees)"
          }
          
          {{- if .Values.dns.ovh.enabled }}
          # Synchroniser secret OVH (requis si DNS OVH active)
          merge_secrets "ovh-global-dns-keys" "ovh-local-dns-keys" "false"
          {{- else }}
          echo "ðŸ”• DNS OVH desactive, synchronisation OVH ignoree"
          {{- end }}

          # Synchroniser askme-tokens (REQUIS - tous les tokens LLM)
          # Ce secret fusionne les valeurs globales avec celles de questions.yaml
          merge_secrets "askme-tokens" "askme-local-tokens" "false"

          # Synchroniser harbor-keys (REQUIS - authentification registry Docker)
          merge_secrets "harbor-keys" "harbor-keys" "false"

          echo "ðŸŽ‰ Synchronisation des secrets terminee avec succes!"
        
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"