apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "askme.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    askme.avanteam.com/client: {{ .Release.Name }}
    askme.avanteam.com/version: {{ .Chart.AppVersion }}
data:
  # Configuration générale
  DEBUG: {{ .Values.config.debug | quote }}
  
  # Interface utilisateur
  UI_TITLE: {{ .Values.ui.title | quote }}
  UI_LOGO: {{ .Values.ui.logo | quote }}
  UI_CHAT_LOGO: {{ .Values.ui.chatLogo | quote }}
  UI_CHAT_TITLE: {{ .Values.ui.chatTitle | quote }}
  UI_CHAT_DESCRIPTION: {{ .Values.ui.description | quote }}
  UI_FAVICON: {{ .Values.ui.favicon | quote }}
  UI_SHOW_SHARE_BUTTON: {{ .Values.ui.showShareButton | quote }}
  UI_SHOW_EXPORT_BUTTON: {{ .Values.ui.showExportButton | quote }}

  # Configuration LLM
  LLM_PROVIDER: {{ .Values.llm.defaultProvider | quote }}
  AVAILABLE_LLM_PROVIDERS: {{ .Values.llm.availableProviders | quote }}

  # Azure OpenAI Configuration
  AZURE_OPENAI_RESOURCE: {{ .Values.azure.openai.resource | quote }}
  AZURE_OPENAI_ENDPOINT: {{ .Values.azure.openai.endpoint | quote }}
  AZURE_OPENAI_MODEL: {{ .Values.azure.openai.model | quote }}
  AZURE_OPENAI_MODEL_NAME: {{ .Values.azure.openai.modelName | quote }}
  AZURE_OPENAI_TEMPERATURE: {{ .Values.azure.openai.temperature | quote }}
  AZURE_OPENAI_TOP_P: {{ .Values.azure.openai.topP | quote }}
  AZURE_OPENAI_STOP_SEQUENCE: {{ .Values.azure.openai.stopSequence | quote }}
  AZURE_OPENAI_SEED: {{ .Values.azure.openai.seed | quote }}
  AZURE_OPENAI_CHOICES_COUNT: {{ .Values.azure.openai.choicesCount | quote }}
  AZURE_OPENAI_PRESENCE_PENALTY: {{ .Values.azure.openai.presencePenalty | quote }}
  AZURE_OPENAI_FREQUENCY_PENALTY: {{ .Values.azure.openai.frequencyPenalty | quote }}
  AZURE_OPENAI_LOGIT_BIAS: {{ .Values.azure.openai.logitBias | quote }}
  AZURE_OPENAI_USER: {{ .Values.azure.openai.user | quote }}
  AZURE_OPENAI_TOOLS: {{ .Values.azure.openai.tools | quote }}
  AZURE_OPENAI_TOOL_CHOICE: {{ .Values.azure.openai.toolChoice | quote }}
  AZURE_OPENAI_STREAM: {{ .Values.azure.openai.stream | quote }}
  AZURE_OPENAI_SYSTEM_MESSAGE: {{ .Values.azure.openai.systemMessage | quote }}
  AZURE_OPENAI_PREVIEW_API_VERSION: {{ .Values.azure.openai.previewApiVersion | quote }}
  AZURE_OPENAI_EMBEDDING_NAME: {{ .Values.azure.openai.embeddingName | quote }}
  AZURE_OPENAI_EMBEDDING_ENDPOINT: {{ .Values.azure.openai.embeddingEndpoint | quote }}
  AZURE_OPENAI_RESPONSE_VERY_SHORT_MAX_TOKENS: {{ .Values.azure.openai.responseVeryShortMaxTokens | quote }}
  AZURE_OPENAI_RESPONSE_NORMAL_MAX_TOKENS: {{ .Values.azure.openai.responseNormalMaxTokens | quote }}
  AZURE_OPENAI_RESPONSE_COMPREHENSIVE_MAX_TOKENS: {{ .Values.azure.openai.responseComprehensiveMaxTokens | quote }}

  # Claude AI Configuration
  CLAUDE_MODEL: {{ .Values.claude.model | quote }}
  CLAUDE_TEMPERATURE: {{ .Values.claude.temperature | quote }}
  CLAUDE_TOP_P: {{ .Values.claude.topP | quote }}
  CLAUDE_SYSTEM_MESSAGE: {{ .Values.claude.systemMessage | quote }}
  CLAUDE_RESPONSE_VERY_SHORT_MAX_TOKENS: {{ .Values.claude.responseVeryShortMaxTokens | quote }}
  CLAUDE_RESPONSE_NORMAL_MAX_TOKENS: {{ .Values.claude.responseNormalMaxTokens | quote }}
  CLAUDE_RESPONSE_COMPREHENSIVE_MAX_TOKENS: {{ .Values.claude.responseComprehensiveMaxTokens | quote }}

  # OpenAI Direct Configuration
  OPENAI_DIRECT_MODEL: {{ .Values.openai.model | quote }}
  OPENAI_DIRECT_TEMPERATURE: {{ .Values.openai.temperature | quote }}
  OPENAI_DIRECT_TOP_P: {{ .Values.openai.topP | quote }}
  OPENAI_DIRECT_STOP_SEQUENCE: {{ .Values.openai.stopSequence | quote }}
  OPENAI_DIRECT_BASE_URL: {{ .Values.openai.baseUrl | quote }}
  OPENAI_DIRECT_SYSTEM_MESSAGE: {{ .Values.openai.systemMessage | quote }}
  OPENAI_DIRECT_RESPONSE_VERY_SHORT_MAX_TOKENS: {{ .Values.openai.responseVeryShortMaxTokens | quote }}
  OPENAI_DIRECT_RESPONSE_NORMAL_MAX_TOKENS: {{ .Values.openai.responseNormalMaxTokens | quote }}
  OPENAI_DIRECT_RESPONSE_COMPREHENSIVE_MAX_TOKENS: {{ .Values.openai.responseComprehensiveMaxTokens | quote }}

  # Mistral AI Configuration
  MISTRAL_MODEL: {{ .Values.mistral.model | quote }}
  MISTRAL_TEMPERATURE: {{ .Values.mistral.temperature | quote }}
  MISTRAL_TOP_P: {{ .Values.mistral.topP | quote }}
  MISTRAL_SYSTEM_MESSAGE: {{ .Values.mistral.systemMessage | quote }}
  MISTRAL_RESPONSE_VERY_SHORT_MAX_TOKENS: {{ .Values.mistral.responseVeryShortMaxTokens | quote }}
  MISTRAL_RESPONSE_NORMAL_MAX_TOKENS: {{ .Values.mistral.responseNormalMaxTokens | quote }}
  MISTRAL_RESPONSE_COMPREHENSIVE_MAX_TOKENS: {{ .Values.mistral.responseComprehensiveMaxTokens | quote }}

  # Gemini AI Configuration
  GEMINI_MODEL: {{ .Values.gemini.model | quote }}
  GEMINI_TEMPERATURE: {{ .Values.gemini.temperature | quote }}
  GEMINI_TOP_P: {{ .Values.gemini.topP | quote }}
  GEMINI_SYSTEM_MESSAGE: {{ .Values.gemini.systemMessage | quote }}
  GEMINI_RESPONSE_VERY_SHORT_MAX_TOKENS: {{ .Values.gemini.responseVeryShortMaxTokens | quote }}
  GEMINI_RESPONSE_NORMAL_MAX_TOKENS: {{ .Values.gemini.responseNormalMaxTokens | quote }}
  GEMINI_RESPONSE_COMPREHENSIVE_MAX_TOKENS: {{ .Values.gemini.responseComprehensiveMaxTokens | quote }}

  # Azure Services Configuration
  AZURE_SEARCH_SERVICE: {{ .Values.azure.search.service | quote }}
  AZURE_SEARCH_INDEX: {{ .Values.azure.search.index | quote }}
  AZURE_SEARCH_SEMANTIC_SEARCH_CONFIG: {{ .Values.azure.search.semanticSearchConfig | quote }}
  AZURE_SEARCH_INDEX_IS_PRECHUNKED: {{ .Values.azure.search.indexIsPrechunked | quote }}
  AZURE_SEARCH_TOP_K: {{ .Values.azure.search.topK | quote }}
  AZURE_SEARCH_ENABLE_IN_DOMAIN: {{ .Values.azure.search.enableInDomain | quote }}
  AZURE_SEARCH_CONTENT_COLUMNS: {{ .Values.azure.search.contentColumns | quote }}
  AZURE_SEARCH_FILENAME_COLUMN: {{ .Values.azure.search.filenameColumn | quote }}
  AZURE_SEARCH_TITLE_COLUMN: {{ .Values.azure.search.titleColumn | quote }}
  AZURE_SEARCH_URL_COLUMN: {{ .Values.azure.search.urlColumn | quote }}
  AZURE_SEARCH_VECTOR_COLUMNS: {{ .Values.azure.search.vectorColumns | quote }}
  AZURE_SEARCH_QUERY_TYPE: {{ .Values.azure.search.queryType | quote }}
  AZURE_SEARCH_PERMITTED_GROUPS_COLUMN: {{ .Values.azure.search.permittedGroupsColumn | quote }}
  AZURE_SEARCH_STRICTNESS: {{ .Values.azure.search.strictness | quote }}

  # Azure Speech Configuration
  AZURE_SPEECH_ENABLED: {{ .Values.azure.speech.enabled | quote }}
  AZURE_SPEECH_REGION: {{ .Values.azure.speech.region | quote }}
  AZURE_SPEECH_VOICE_FR: {{ .Values.azure.speech.voiceFr | quote }}
  AZURE_SPEECH_VOICE_EN: {{ .Values.azure.speech.voiceEn | quote }}

  # History Provider Configuration
  HISTORY_PROVIDER: {{ .Values.config.historyProvider | quote }}

  # Azure CosmosDB Configuration
  AZURE_COSMOSDB_ACCOUNT: {{ .Values.azure.cosmosdb.account | quote }}
  AZURE_COSMOSDB_DATABASE: {{ .Values.azure.cosmosdb.database | quote }}
  AZURE_COSMOSDB_CONVERSATIONS_CONTAINER: {{ .Values.azure.cosmosdb.conversationsContainer | quote }}
  AZURE_COSMOSDB_ENABLE_FEEDBACK: {{ .Values.azure.cosmosdb.enableFeedback | quote }}

  # MongoDB Configuration (pour historique conversations)
  {{- if or (.Values.mongodb.enabled) (eq .Values.config.historyProvider "MONGODB") }}
  {{- if not .Values.mongodb.autoInit }}
  # Configuration MongoDB manuelle (quand auto-init est désactivé)
  MONGODB_URI: {{ .Values.mongodb.uri | quote }}
  MONGODB_DATABASE: {{ printf "askme_%s" (.Release.Name | replace "askme-" "" | replace "." "_") | quote }}
  {{- end }}
  MONGODB_ENABLE_FEEDBACK: {{ .Values.mongodb.enableFeedback | quote }}
  # Note: MONGODB_URI et MONGODB_DATABASE sont injectés depuis le Secret quand autoInit=true
  {{- end }}

  # Configuration des sources de données
  DATASOURCE_TYPE: {{ .Values.config.datasourceType | quote }}
  SEARCH_TOP_K: {{ .Values.config.searchTopK | quote }}
  SEARCH_STRICTNESS: {{ .Values.config.searchStrictness | quote }}
  SEARCH_ENABLE_IN_DOMAIN: {{ .Values.config.searchEnableInDomain | quote }}
  IMAGE_MAX_SIZE_MB: {{ .Values.config.imageMaxSizeMb | quote }}
  CITATION_CONTENT_MAX_LENGTH: {{ .Values.config.citationContentMaxLength | quote }}
  DEFAULT_LANGUAGE: {{ .Values.config.defaultLanguage | quote }}
  AZURE_USE_AUTHENTICATION: {{ .Values.config.azureUseAuthentication | quote }}
  CHAT_HISTORY_ENABLED: {{ .Values.config.chatHistoryEnabled | quote }}
  ORCHESTRATION_STRATEGY: {{ .Values.config.orchestrationStrategy | quote }}
  
  # Services vocaux
  VOICE_INPUT_ENABLED: {{ .Values.voice.inputEnabled | quote }}
  WAKE_WORD_ENABLED: {{ .Values.voice.wakeWordEnabled | quote }}
  WAKE_WORD_PHRASES: {{ printf "[%s]" (replace "," "\", \"" .Values.voice.wakeWords) | quote }}
  WAKE_WORD_VARIANTS: {{ .Values.voice.wakeWordVariants | quote }}
  
  # NOTE: Section Azure Speech supprimée - définie ligne 108-112
  # NOTE: Section Configuration générale nettoyée - duplications supprimées
  
  # Avanteam Custom Configuration
  AVANTEAM_URL_BASE: {{ .Values.avanteam.urlBase | quote }}
  AVANTEAM_LICENCEHUB_HANDLERURL: {{ .Values.avanteam.licenceHubHandlerUrl | quote }}
  AVANTEAM_LICENCEHUB_KEY: {{ .Values.avanteam.licenceHubKey | quote }}
  AUTH_ENABLED: {{ .Values.authentication.enabled | quote }}
  # NOTE: AVANTEAM_AUTH_TOKEN est maintenant dans le Secret askme-local-tokens
  SCM_DO_BUILD_DURING_DEPLOYMENT: {{ .Values.config.scmDoBuildDuringDeployment | quote }}

  # MS Defender Configuration
  MS_DEFENDER_ENABLED: {{ .Values.msDefender.enabled | quote }}
  MS_DEFENDER_ENDPOINT: {{ .Values.msDefender.endpoint | quote }}

  # Usage Tracking Configuration
  USAGE_TRACKER_ENABLED: {{ .Values.usageTracking.enabled | quote }}
  USAGE_TRACKER_COSMOS_CONTAINER_NAME: {{ .Values.usageTracking.cosmosContainerName | quote }}
  USAGE_TRACKER_STORE_DETAILED_METRICS: {{ .Values.usageTracking.storeDetailedMetrics | quote }}
  USAGE_TRACKER_IMAGE_TOKENS_PER_BYTE: {{ .Values.usageTracking.imageTokensPerByte | quote }}

  # External API Configuration
  EXTERNAL_API_ENABLED: {{ .Values.externalApi.enabled | quote }}
  {{- if .Values.externalApi.keys }}
  # Clés API spécifiques à ce déploiement
  EXTERNAL_API_KEYS: {{ .Values.externalApi.keys | quote }}
  {{- else }}
  # Note: EXTERNAL_API_KEYS sera fournie par le secret 'askme-local-tokens'
  {{- end }}
  EXTERNAL_API_RATE_LIMIT_PER_MINUTE: {{ .Values.externalApi.rateLimitPerMinute | quote }}
  EXTERNAL_API_RATE_LIMIT_PER_HOUR: {{ .Values.externalApi.rateLimitPerHour | quote }}
  EXTERNAL_API_MAX_RESULTS: {{ .Values.externalApi.maxResults | quote }}
  EXTERNAL_API_REQUEST_TIMEOUT: {{ .Values.externalApi.requestTimeout | quote }}
  EXTERNAL_API_SWAGGER_ENABLED: {{ .Values.externalApi.swagger.enabled | quote }}
  EXTERNAL_API_TITLE: {{ .Values.externalApi.title | quote }}
  EXTERNAL_API_DESCRIPTION: {{ .Values.externalApi.description | quote }}
  EXTERNAL_API_VERSION: {{ .Values.externalApi.version | quote }}
  
  # Autres datasources (vides mais présentes pour éviter les erreurs)
  AZURE_COSMOSDB_MONGO_VCORE_CONNECTION_STRING: {{ .Values.datasources.cosmosdbMongo.connectionString | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_DATABASE: {{ .Values.datasources.cosmosdbMongo.database | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_CONTAINER: {{ .Values.datasources.cosmosdbMongo.container | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_INDEX: {{ .Values.datasources.cosmosdbMongo.index | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_TOP_K: {{ .Values.datasources.cosmosdbMongo.topK | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_STRICTNESS: {{ .Values.datasources.cosmosdbMongo.strictness | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_ENABLE_IN_DOMAIN: {{ .Values.datasources.cosmosdbMongo.enableInDomain | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_CONTENT_COLUMNS: {{ .Values.datasources.cosmosdbMongo.contentColumns | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_FILENAME_COLUMN: {{ .Values.datasources.cosmosdbMongo.filenameColumn | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_TITLE_COLUMN: {{ .Values.datasources.cosmosdbMongo.titleColumn | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_URL_COLUMN: {{ .Values.datasources.cosmosdbMongo.urlColumn | quote }}
  AZURE_COSMOSDB_MONGO_VCORE_VECTOR_COLUMNS: {{ .Values.datasources.cosmosdbMongo.vectorColumns | quote }}
  
  ELASTICSEARCH_ENDPOINT: {{ .Values.datasources.elasticsearch.endpoint | quote }}
  ELASTICSEARCH_ENCODED_API_KEY: {{ .Values.datasources.elasticsearch.encodedApiKey | quote }}
  ELASTICSEARCH_INDEX: {{ .Values.datasources.elasticsearch.index | quote }}
  ELASTICSEARCH_QUERY_TYPE: {{ .Values.datasources.elasticsearch.queryType | quote }}
  ELASTICSEARCH_TOP_K: {{ .Values.datasources.elasticsearch.topK | quote }}
  ELASTICSEARCH_ENABLE_IN_DOMAIN: {{ .Values.datasources.elasticsearch.enableInDomain | quote }}
  ELASTICSEARCH_CONTENT_COLUMNS: {{ .Values.datasources.elasticsearch.contentColumns | quote }}
  ELASTICSEARCH_FILENAME_COLUMN: {{ .Values.datasources.elasticsearch.filenameColumn | quote }}
  ELASTICSEARCH_TITLE_COLUMN: {{ .Values.datasources.elasticsearch.titleColumn | quote }}
  ELASTICSEARCH_URL_COLUMN: {{ .Values.datasources.elasticsearch.urlColumn | quote }}
  ELASTICSEARCH_VECTOR_COLUMNS: {{ .Values.datasources.elasticsearch.vectorColumns | quote }}
  ELASTICSEARCH_STRICTNESS: {{ .Values.datasources.elasticsearch.strictness | quote }}
  ELASTICSEARCH_EMBEDDING_MODEL_ID: {{ .Values.datasources.elasticsearch.embeddingModelId | quote }}
  
  PINECONE_ENVIRONMENT: {{ .Values.datasources.pinecone.environment | quote }}
  PINECONE_API_KEY: {{ .Values.datasources.pinecone.apiKey | quote }}
  PINECONE_INDEX_NAME: {{ .Values.datasources.pinecone.indexName | quote }}
  PINECONE_TOP_K: {{ .Values.datasources.pinecone.topK | quote }}
  PINECONE_STRICTNESS: {{ .Values.datasources.pinecone.strictness | quote }}
  PINECONE_ENABLE_IN_DOMAIN: {{ .Values.datasources.pinecone.enableInDomain | quote }}
  PINECONE_CONTENT_COLUMNS: {{ .Values.datasources.pinecone.contentColumns | quote }}
  PINECONE_FILENAME_COLUMN: {{ .Values.datasources.pinecone.filenameColumn | quote }}
  PINECONE_TITLE_COLUMN: {{ .Values.datasources.pinecone.titleColumn | quote }}
  PINECONE_URL_COLUMN: {{ .Values.datasources.pinecone.urlColumn | quote }}
  PINECONE_VECTOR_COLUMNS: {{ .Values.datasources.pinecone.vectorColumns | quote }}
  
  AZURE_MLINDEX_NAME: {{ .Values.datasources.azureML.indexName | quote }}
  AZURE_MLINDEX_VERSION: {{ .Values.datasources.azureML.indexVersion | quote }}
  AZURE_ML_PROJECT_RESOURCE_ID: {{ .Values.datasources.azureML.projectResourceId | quote }}
  AZURE_MLINDEX_TOP_K: {{ .Values.datasources.azureML.topK | quote }}
  AZURE_MLINDEX_STRICTNESS: {{ .Values.datasources.azureML.strictness | quote }}
  AZURE_MLINDEX_ENABLE_IN_DOMAIN: {{ .Values.datasources.azureML.enableInDomain | quote }}
  AZURE_MLINDEX_CONTENT_COLUMNS: {{ .Values.datasources.azureML.contentColumns | quote }}
  AZURE_MLINDEX_FILENAME_COLUMN: {{ .Values.datasources.azureML.filenameColumn | quote }}
  AZURE_MLINDEX_TITLE_COLUMN: {{ .Values.datasources.azureML.titleColumn | quote }}
  AZURE_MLINDEX_URL_COLUMN: {{ .Values.datasources.azureML.urlColumn | quote }}
  AZURE_MLINDEX_VECTOR_COLUMNS: {{ .Values.datasources.azureML.vectorColumns | quote }}
  AZURE_MLINDEX_QUERY_TYPE: {{ .Values.datasources.azureML.queryType | quote }}
  
  USE_PROMPTFLOW: {{ .Values.datasources.promptflow.enabled | quote }}
  PROMPTFLOW_ENDPOINT: {{ .Values.datasources.promptflow.endpoint | quote }}
  PROMPTFLOW_API_KEY: {{ .Values.datasources.promptflow.apiKey | quote }}
  PROMPTFLOW_RESPONSE_TIMEOUT: {{ .Values.datasources.promptflow.responseTimeout | quote }}
  PROMPTFLOW_REQUEST_FIELD_NAME: {{ .Values.datasources.promptflow.requestFieldName | quote }}
  PROMPTFLOW_RESPONSE_FIELD_NAME: {{ .Values.datasources.promptflow.responseFieldName | quote }}
  PROMPTFLOW_CITATIONS_FIELD_NAME: {{ .Values.datasources.promptflow.citationsFieldName | quote }}
  
  MONGODB_ENDPOINT: {{ .Values.datasources.mongodb.endpoint | quote }}
  MONGODB_USERNAME: {{ .Values.datasources.mongodb.username | quote }}
  MONGODB_PASSWORD: {{ .Values.datasources.mongodb.password | quote }}
  MONGODB_DATABASE_NAME: {{ .Values.datasources.mongodb.databaseName | quote }}
  MONGODB_COLLECTION_NAME: {{ .Values.datasources.mongodb.collectionName | quote }}
  MONGODB_APP_NAME: {{ .Values.datasources.mongodb.appName | quote }}
  MONGODB_INDEX_NAME: {{ .Values.datasources.mongodb.indexName | quote }}
  MONGODB_TOP_K: {{ .Values.datasources.mongodb.topK | quote }}
  MONGODB_STRICTNESS: {{ .Values.datasources.mongodb.strictness | quote }}
  MONGODB_ENABLE_IN_DOMAIN: {{ .Values.datasources.mongodb.enableInDomain | quote }}
  MONGODB_CONTENT_COLUMNS: {{ .Values.datasources.mongodb.contentColumns | quote }}
  MONGODB_FILENAME_COLUMN: {{ .Values.datasources.mongodb.filenameColumn | quote }}
  MONGODB_TITLE_COLUMN: {{ .Values.datasources.mongodb.titleColumn | quote }}
  MONGODB_URL_COLUMN: {{ .Values.datasources.mongodb.urlColumn | quote }}
  MONGODB_VECTOR_COLUMNS: {{ .Values.datasources.mongodb.vectorColumns | quote }}