{{- if and (or (.Values.mongodb.enabled) (eq .Values.config.historyProvider "MONGODB")) .Values.mongodb.autoInit }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    askme.avanteam.com/component: "mongodb-init-job"
  annotations:
    askme.avanteam.com/client: {{ .Release.Name }}
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "askme.selectorLabels" . | nindent 8 }}
        askme.avanteam.com/component: "mongodb-init-job"
    spec:
      restartPolicy: Never
      containers:
      - name: mongodb-init
        image: mongo:7.0
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "ðŸš€ Initialisation MongoDB pour client: {{ .Release.Name }}"

          # Variables
          CLIENT_NAME="{{ .Release.Name | replace "askme-" "" | replace "." "_" }}"
          DATABASE_NAME="askme_${CLIENT_NAME}"
          USERNAME="askme_${CLIENT_NAME}_user"

          # GÃ©nÃ©rer un mot de passe sÃ©curisÃ© (32 caractÃ¨res)
          PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)

          # URI de connexion admin
          ADMIN_URI="{{ .Values.mongodb.adminUri | default "mongodb://root:AskMe-MongoDB-2024-Secure!@mongodb-external:27017/?authSource=admin&replicaSet=rs0" }}"

          echo "ðŸ“Š Configuration:"
          echo "  - Client: ${CLIENT_NAME}"
          echo "  - Database: ${DATABASE_NAME}"
          echo "  - Username: ${USERNAME}"
          echo "  - Password: [GENERATED]"

          # Script MongoDB Ã  exÃ©cuter
          cat > /tmp/init-script.js << 'EOF'
          // Variables injectÃ©es depuis l'environnement
          const CLIENT_NAME = process.env.CLIENT_NAME;
          const DATABASE_NAME = process.env.DATABASE_NAME;
          const USERNAME = process.env.USERNAME;
          const PASSWORD = process.env.PASSWORD;

          print(`ðŸ”§ Initialisation de la database: ${DATABASE_NAME}`);

          // Se connecter Ã  la database du client (elle sera crÃ©Ã©e si n'existe pas)
          use(DATABASE_NAME);

          // VÃ©rifier si la database existe dÃ©jÃ 
          const existingUser = db.getUser(USERNAME);
          if (existingUser) {
              print(`âš ï¸  L'utilisateur ${USERNAME} existe dÃ©jÃ  - mise Ã  jour du mot de passe`);
              db.updateUser(USERNAME, {
                  pwd: PASSWORD,
                  roles: [
                      {role: "readWrite", db: DATABASE_NAME}
                  ]
              });
          } else {
              print(`ðŸ‘¤ CrÃ©ation de l'utilisateur ${USERNAME}`);
              db.createUser({
                  user: USERNAME,
                  pwd: PASSWORD,
                  roles: [
                      {role: "readWrite", db: DATABASE_NAME}
                  ],
                  customData: {
                      description: `AskMe user for client ${CLIENT_NAME}`,
                      createdBy: "AskMe Rancher Deployment",
                      createdAt: new Date().toISOString()
                  }
              });
          }

          // CrÃ©er les collections avec schÃ©ma de validation
          try {
              db.createCollection("conversations", {
                  validator: {
                      $jsonSchema: {
                          bsonType: "object",
                          required: ["_id", "userId", "type", "createdAt", "updatedAt"],
                          properties: {
                              _id: {bsonType: "string"},
                              userId: {bsonType: "string"},
                              type: {bsonType: "string", enum: ["conversation"]},
                              title: {bsonType: "string"},
                              createdAt: {bsonType: ["string", "date"]},
                              updatedAt: {bsonType: ["string", "date"]}
                          }
                      }
                  }
              });
              print("âœ… Collection 'conversations' crÃ©Ã©e");
          } catch (e) {
              if (e.codeName === "NamespaceExists") {
                  print("â„¹ï¸  Collection 'conversations' existe dÃ©jÃ ");
              } else {
                  print("âŒ Erreur crÃ©ation collection 'conversations':", e);
              }
          }

          try {
              db.createCollection("messages", {
                  validator: {
                      $jsonSchema: {
                          bsonType: "object",
                          required: ["_id", "userId", "conversationId", "type", "role", "content", "createdAt"],
                          properties: {
                              _id: {bsonType: "string"},
                              userId: {bsonType: "string"},
                              conversationId: {bsonType: "string"},
                              type: {bsonType: "string", enum: ["message"]},
                              role: {bsonType: "string", enum: ["user", "assistant", "system", "tool"]},
                              content: {},
                              createdAt: {bsonType: ["string", "date"]},
                              updatedAt: {bsonType: ["string", "date"]},
                              timestamp: {bsonType: "date"}
                          }
                      }
                  }
              });
              print("âœ… Collection 'messages' crÃ©Ã©e");
          } catch (e) {
              if (e.codeName === "NamespaceExists") {
                  print("â„¹ï¸  Collection 'messages' existe dÃ©jÃ ");
              } else {
                  print("âŒ Erreur crÃ©ation collection 'messages':", e);
              }
          }

          // CrÃ©er les index pour optimiser les performances
          print("ðŸ“Š CrÃ©ation des index...");

          // Index sur conversations
          db.conversations.createIndex({userId: 1, type: 1});
          db.conversations.createIndex({userId: 1, updatedAt: -1});

          // Index sur messages
          db.messages.createIndex({userId: 1, conversationId: 1, type: 1});
          db.messages.createIndex({conversationId: 1, timestamp: 1});
          db.messages.createIndex({userId: 1, type: 1});

          print("âœ… Index crÃ©Ã©s");

          // Test d'Ã©criture
          const testResult = db.conversations.insertOne({
              _id: "test-conversation-init",
              userId: "test-user-init",
              type: "conversation",
              title: "Test Init - Auto Delete",
              createdAt: new Date(),
              updatedAt: new Date()
          });

          if (testResult.acknowledged) {
              print("âœ… Test d'Ã©criture rÃ©ussi");
              db.conversations.deleteOne({_id: "test-conversation-init"});
              print("âœ… Nettoyage test effectuÃ©");
          }

          print(`ðŸŽ‰ Initialisation terminÃ©e pour ${DATABASE_NAME}`);
          EOF

          # Exporter les variables d'environnement pour le script
          export CLIENT_NAME
          export DATABASE_NAME
          export USERNAME
          export PASSWORD

          echo "ðŸš€ ExÃ©cution du script d'initialisation MongoDB..."
          mongosh "${ADMIN_URI}" --file /tmp/init-script.js

          echo "ðŸ’¾ CrÃ©ation du Secret Kubernetes avec les credentials..."

          # CrÃ©er le fichier de credentials pour le Secret
          cat > /tmp/mongodb-credentials.yaml << EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: {{ include "askme.fullname" . }}-mongodb-credentials
            namespace: {{ .Release.Namespace }}
            labels:
              {{- include "askme.labels" . | nindent 6 }}
              askme.avanteam.com/component: mongodb-credentials
            annotations:
              askme.avanteam.com/client: {{ .Release.Name }}
              askme.avanteam.com/database: ${DATABASE_NAME}
              askme.avanteam.com/created-by: mongodb-init-job
          type: Opaque
          stringData:
            MONGODB_URI: "mongodb://\${USERNAME}:\${PASSWORD}@{{ .Values.mongodb.externalService.name | default \"mongodb-external\" }}:{{ .Values.mongodb.externalService.port | default 27017 }}/\${DATABASE_NAME}?replicaSet=rs0&readPreference=secondaryPreferred&authSource=\${DATABASE_NAME}"
            MONGODB_DATABASE: "\${DATABASE_NAME}"
            MONGODB_USERNAME: "\${USERNAME}"
            MONGODB_PASSWORD: "\${PASSWORD}"
          EOF

          # Appliquer le Secret via kubectl
          kubectl apply -f /tmp/mongodb-credentials.yaml

          echo "âœ… Secret MongoDB crÃ©Ã© avec succÃ¨s"
          echo "ðŸ”— URI de connexion: mongodb://\${USERNAME}:[PASSWORD]@{{ .Values.mongodb.externalService.name | default \"mongodb-external\" }}:{{ .Values.mongodb.externalService.port | default 27017 }}/\${DATABASE_NAME}?replicaSet=rs0&readPreference=secondaryPreferred&authSource=\${DATABASE_NAME}"
          echo "ðŸŽ‰ Initialisation MongoDB terminÃ©e pour le client {{ .Release.Name }}"

        env:
        - name: MONGODB_ADMIN_URI
          value: {{ .Values.mongodb.adminUri | default "mongodb://root:AskMe-MongoDB-2024-Secure!@mongodb-external:27017/?authSource=admin&replicaSet=rs0" | quote }}

        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi

      serviceAccountName: {{ include "askme.fullname" . }}-mongodb-init

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "update", "patch", "get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
subjects:
- kind: ServiceAccount
  name: {{ include "askme.fullname" . }}-mongodb-init
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ include "askme.fullname" . }}-mongodb-init
  apiGroup: rbac.authorization.k8s.io
{{- end }}