{{- if and (or (.Values.mongodb.enabled) (eq .Values.config.historyProvider "MONGODB")) .Values.mongodb.autoInit }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-init-{{ .Chart.Version | replace "." "-" }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    app.kubernetes.io/component: mongodb-manager
  annotations:
    askme.avanteam.com/job-type: "mongodb-init"
    askme.avanteam.com/depends-on: "secret-sync"
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "askme.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: mongodb-manager
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "askme.fullname" . }}-mongodb-manager
      containers:
      - name: mongodb-init
        image: mongo:7.0
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Initialisation MongoDB pour client: {{ .Release.Name }}"

          # Variables
          CLIENT_NAME="{{ .Release.Name | replace "askme-" "" | replace "." "_" }}"
          DATABASE_NAME="askme_${CLIENT_NAME}"
          USERNAME="askme_${CLIENT_NAME}_user"

          # Générer un mot de passe sécurisé (32 caractères)
          PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)

          # URI de connexion admin
          ADMIN_URI="{{ .Values.mongodb.adminUri | default "mongodb://root:AskMe-MongoDB-2024-Secure!@mongodb-external:27017/?authSource=admin&replicaSet=rs0" }}"

          echo "Configuration:"
          echo "  - Client: ${CLIENT_NAME}"
          echo "  - Database: ${DATABASE_NAME}"
          echo "  - Username: ${USERNAME}"
          echo "  - Password: [GENERATED]"

          # Script MongoDB à exécuter
          cat > /tmp/init-script.js << 'EOF'
          // Variables injectées depuis l'environnement
          const CLIENT_NAME = process.env.CLIENT_NAME;
          const DATABASE_NAME = process.env.DATABASE_NAME;
          const USERNAME = process.env.USERNAME;
          const PASSWORD = process.env.PASSWORD;

          print(`Initialisation de la database: ${DATABASE_NAME}`);

          // Se connecter à la database du client (elle sera créée si n'existe pas)
          use(DATABASE_NAME);

          // Vérifier si la database existe déjà
          const existingUser = db.getUser(USERNAME);
          if (existingUser) {
              print(`L'utilisateur ${USERNAME} existe déjà - mise à jour du mot de passe`);
              db.updateUser(USERNAME, {
                  pwd: PASSWORD,
                  roles: [
                      {role: "readWrite", db: DATABASE_NAME}
                  ]
              });
          } else {
              print(`Création de l'utilisateur ${USERNAME}`);
              db.createUser({
                  user: USERNAME,
                  pwd: PASSWORD,
                  roles: [
                      {role: "readWrite", db: DATABASE_NAME}
                  ],
                  customData: {
                      description: `AskMe user for client ${CLIENT_NAME}`,
                      createdBy: "AskMe Rancher Deployment",
                      createdAt: new Date().toISOString()
                  }
              });
          }

          // Créer les collections avec schéma de validation
          try {
              db.createCollection("conversations", {
                  validator: {
                      $jsonSchema: {
                          bsonType: "object",
                          required: ["_id", "userId", "type", "createdAt", "updatedAt"],
                          properties: {
                              _id: {bsonType: "string"},
                              userId: {bsonType: "string"},
                              type: {bsonType: "string", enum: ["conversation"]},
                              title: {bsonType: "string"},
                              createdAt: {bsonType: ["string", "date"]},
                              updatedAt: {bsonType: ["string", "date"]}
                          }
                      }
                  }
              });
              print("Collection 'conversations' créée");
          } catch (e) {
              if (e.codeName === "NamespaceExists") {
                  print("Collection 'conversations' existe déjà");
              } else {
                  print("Erreur création collection 'conversations':", e);
              }
          }

          try {
              db.createCollection("messages", {
                  validator: {
                      $jsonSchema: {
                          bsonType: "object",
                          required: ["_id", "userId", "conversationId", "type", "role", "content", "createdAt"],
                          properties: {
                              _id: {bsonType: "string"},
                              userId: {bsonType: "string"},
                              conversationId: {bsonType: "string"},
                              type: {bsonType: "string", enum: ["message"]},
                              role: {bsonType: "string", enum: ["user", "assistant", "system", "tool"]},
                              content: {},
                              createdAt: {bsonType: ["string", "date"]},
                              updatedAt: {bsonType: ["string", "date"]},
                              timestamp: {bsonType: "date"}
                          }
                      }
                  }
              });
              print("Collection 'messages' créée");
          } catch (e) {
              if (e.codeName === "NamespaceExists") {
                  print("Collection 'messages' existe déjà");
              } else {
                  print("Erreur création collection 'messages':", e);
              }
          }

          // Créer les index pour optimiser les performances
          print("Création des index...");

          // Index sur conversations
          db.conversations.createIndex({userId: 1, type: 1});
          db.conversations.createIndex({userId: 1, updatedAt: -1});

          // Index sur messages
          db.messages.createIndex({userId: 1, conversationId: 1, type: 1});
          db.messages.createIndex({conversationId: 1, timestamp: 1});
          db.messages.createIndex({userId: 1, type: 1});

          print("Index créés");

          // Test d'écriture
          const testResult = db.conversations.insertOne({
              _id: "test-conversation-init",
              userId: "test-user-init",
              type: "conversation",
              title: "Test Init - Auto Delete",
              createdAt: new Date(),
              updatedAt: new Date()
          });

          if (testResult.acknowledged) {
              print("Test d'écriture réussi");
              db.conversations.deleteOne({_id: "test-conversation-init"});
              print("Nettoyage test effectué");
          }

          print(`Initialisation terminée pour ${DATABASE_NAME}`);
          EOF

          # Exporter les variables d'environnement pour le script
          export CLIENT_NAME
          export DATABASE_NAME
          export USERNAME
          export PASSWORD

          echo "Exécution du script d'initialisation MongoDB..."
          mongosh "${ADMIN_URI}" --file /tmp/init-script.js

          echo "Création du Secret Kubernetes avec les credentials..."

          # Créer le fichier de credentials pour le Secret
          MONGODB_SERVICE_NAME='{{ .Values.mongodb.externalService.name | default "mongodb-external" }}'
          MONGODB_SERVICE_PORT='{{ .Values.mongodb.externalService.port | default 27017 }}'

          # Variables pour les labels Helm
          HELM_LABELS='{{ include "askme.labels" . | indent 14 }}'
          RELEASE_NAME='{{ .Release.Name }}'
          RELEASE_NAMESPACE='{{ .Release.Namespace }}'
          CHART_FULLNAME='{{ include "askme.fullname" . }}'

          cat > /tmp/mongodb-credentials.yaml << EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: ${CHART_FULLNAME}-mongodb-credentials
            namespace: ${RELEASE_NAMESPACE}
            labels:
          ${HELM_LABELS}
              askme.avanteam.com/component: mongodb-credentials
            annotations:
              askme.avanteam.com/client: ${RELEASE_NAME}
              askme.avanteam.com/database: ${DATABASE_NAME}
              askme.avanteam.com/created-by: mongodb-init-job
          type: Opaque
          stringData:
            MONGODB_URI: "mongodb://${USERNAME}:${PASSWORD}@${MONGODB_SERVICE_NAME}:${MONGODB_SERVICE_PORT}/${DATABASE_NAME}?replicaSet=rs0&readPreference=secondaryPreferred&authSource=${DATABASE_NAME}"
            MONGODB_DATABASE: "${DATABASE_NAME}"
            MONGODB_USERNAME: "${USERNAME}"
            MONGODB_PASSWORD: "${PASSWORD}"
          EOF

          # Appliquer le Secret via kubectl
          kubectl apply -f /tmp/mongodb-credentials.yaml

          echo "Secret MongoDB créé avec succès"
          echo "URI de connexion: mongodb://${USERNAME}:[PASSWORD]@${MONGODB_SERVICE_NAME}:${MONGODB_SERVICE_PORT}/${DATABASE_NAME}?replicaSet=rs0&readPreference=secondaryPreferred&authSource=${DATABASE_NAME}"
          echo "Initialisation MongoDB terminée pour le client {{ .Release.Name }}"

        env:
        - name: MONGODB_ADMIN_URI
          value: {{ .Values.mongodb.adminUri | default "mongodb://root:AskMe-MongoDB-2024-Secure!@mongodb-external:27017/?authSource=admin&replicaSet=rs0" | quote }}

        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi


---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-manager
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-manager
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "update", "patch", "get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "askme.fullname" . }}-mongodb-manager
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
subjects:
- kind: ServiceAccount
  name: {{ include "askme.fullname" . }}-mongodb-manager
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ include "askme.fullname" . }}-mongodb-manager
  apiGroup: rbac.authorization.k8s.io
{{- end }}
