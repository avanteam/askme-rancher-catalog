{{- if .Values.dns.ovh.enabled }}
# Job pour synchroniser le secret OVH depuis askme-platform
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "askme.fullname" . }}-sync-ovh-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    app.kubernetes.io/component: secret-sync
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-1"  # Avant le DNS job
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 120
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "askme.fullname" . }}-dns-manager
      containers:
      - name: secret-sync
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "üîê Synchronisation secrets globaux cross-namespace..."
          echo "üìã Source 1: ovh-global-dns-keys@askme-platform"
          echo "üìã Source 2: askme-tokens@askme-platform"
          echo "üéØ Destination: ovh-local-dns-keys + askme-local-tokens@{{ .Release.Namespace }}"
          
          # Synchroniser secret OVH
          if kubectl get secret ovh-global-dns-keys -n askme-platform >/dev/null 2>&1; then
            kubectl get secret ovh-global-dns-keys -n askme-platform -o json | \
              jq '.metadata = {"name": "ovh-local-dns-keys", "namespace": "{{ .Release.Namespace }}"}' | \
              kubectl apply -f -
            echo "‚úÖ Secret OVH synchronis√©"
          else
            echo "‚ö†Ô∏è Secret ovh-global-dns-keys non trouv√© (optionnel)"
          fi
          
          # Synchroniser secret askme-tokens  
          if kubectl get secret askme-tokens -n askme-platform >/dev/null 2>&1; then
            kubectl get secret askme-tokens -n askme-platform -o json | \
              jq '.metadata = {"name": "askme-local-tokens", "namespace": "{{ .Release.Namespace }}"}' | \
              kubectl apply -f -
            echo "‚úÖ Secret askme-tokens synchronis√©"
          else
            echo "‚ö†Ô∏è Secret askme-tokens non trouv√© (optionnel)"
          fi
          
          echo "‚úÖ Synchronisation compl√®te termin√©e"
{{- end }}