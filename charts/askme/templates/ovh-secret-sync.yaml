{{- if .Values.dns.ovh.enabled }}
# Job pour synchroniser le secret OVH depuis askme-platform
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "askme.fullname" . }}-sync-ovh-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    app.kubernetes.io/component: secret-sync
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "1"  # Avant le DNS job
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 120
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "askme.fullname" . }}-dns-manager
      containers:
      - name: secret-sync
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "üîê Synchronisation secrets globaux cross-namespace..."
          echo "üìã Source 1: ovh-global-dns-keys@askme-platform"
          echo "üìã Source 2: askme-tokens@askme-platform"
          echo "üéØ Destination: ovh-local-dns-keys + askme-local-tokens@{{ .Release.Namespace }}"
          
          # Synchroniser secret OVH
          if kubectl get secret ovh-global-dns-keys -n askme-platform >/dev/null 2>&1; then
            kubectl get secret ovh-global-dns-keys -n askme-platform -o json | \
              jq '.metadata = {"name": "ovh-local-dns-keys", "namespace": "{{ .Release.Namespace }}"}' | \
              kubectl apply -f -
            echo "‚úÖ Secret OVH synchronis√©"
          else
            echo "‚ö†Ô∏è Secret ovh-global-dns-keys non trouv√© (optionnel)"
          fi
          
          # Fusionner askme-tokens DANS le secret client
          if kubectl get secret askme-tokens -n askme-platform >/dev/null 2>&1; then
            echo "üîó Fusion askme-tokens dans {{ include "askme.fullname" . }}-secrets..."
            
            # Attendre que le secret client existe
            for i in {1..30}; do
              if kubectl get secret {{ include "askme.fullname" . }}-secrets -n {{ .Release.Namespace }} >/dev/null 2>&1; then
                break
              fi
              echo "‚è≥ Attente secret client... ($i/30)"
              sleep 2
            done
            
            # R√©cup√©rer askme-tokens global
            kubectl get secret askme-tokens -n askme-platform -o json > /tmp/global-tokens.json
            
            # R√©cup√©rer secret client actuel
            kubectl get secret {{ include "askme.fullname" . }}-secrets -n {{ .Release.Namespace }} -o json > /tmp/client-secret.json
            
            # Fusion: Global prioritaire, client en override
            jq -s '
              .[0].data as $global_tokens |
              .[1] as $client_secret |
              $client_secret |
              .data = ($global_tokens + (.data // {}))
            ' /tmp/global-tokens.json /tmp/client-secret.json | \
              kubectl apply -f -
            
            echo "‚úÖ askme-tokens fusionn√© dans secret client"
          else
            echo "‚ö†Ô∏è Secret askme-tokens non trouv√© (optionnel)"
          fi
          
          echo "‚úÖ Synchronisation compl√®te termin√©e"
{{- end }}