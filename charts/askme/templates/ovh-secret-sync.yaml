{{- if .Values.dns.ovh.enabled }}
# Job pour synchroniser le secret OVH depuis askme-platform
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "askme.fullname" . }}-sync-ovh-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    app.kubernetes.io/component: secret-sync
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-1"  # Avant le DNS job
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 120
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "askme.fullname" . }}-dns-manager
      containers:
      - name: secret-sync
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "ğŸ” Synchronisation secret OVH cross-namespace..."
          echo "ğŸ“‹ Source: ovh-global-dns-keys@askme-platform"
          echo "ğŸ¯ Destination: ovh-local-dns-keys@{{ .Release.Namespace }}"
          
          # VÃ©rifier secret source
          if ! kubectl get secret ovh-global-dns-keys -n askme-platform >/dev/null 2>&1; then
            echo "âŒ Secret 'ovh-global-dns-keys' non trouvÃ© dans askme-platform"
            echo "ğŸ’¡ CrÃ©ez-le via: Rancher UI â†’ askme-platform â†’ Secrets â†’ ovh-global-dns-keys"
            exit 1
          fi
          
          # Extraire et recrÃ©er le secret
          kubectl get secret ovh-global-dns-keys -n askme-platform -o json | \
            jq '.metadata = {"name": "ovh-local-dns-keys", "namespace": "{{ .Release.Namespace }}"}' | \
            kubectl apply -f -
          
          echo "âœ… Secret OVH synchronisÃ© avec succÃ¨s"
{{- end }}