{{- if .Values.dns.ovh.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "askme.fullname" . }}-copy-ovh-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    app.kubernetes.io/component: secret-copier
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-1"  # Avant tout le reste
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "askme.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: secret-copier
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "askme.fullname" . }}-secret-copier
      containers:
      - name: secret-copier
        image: bitnami/kubectl:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "üîê Copie du secret OVH global vers namespace client..."
          echo "üìã Source: ovh-global-dns-keys (askme-platform)"
          echo "üéØ Destination: ovh-global-dns-keys ({{ .Release.Namespace }})"
          
          # V√©rifier si le secret source existe
          if ! kubectl get secret ovh-global-dns-keys -n askme-platform >/dev/null 2>&1; then
            echo "‚ùå Secret source 'ovh-global-dns-keys' non trouv√© dans 'askme-platform'"
            echo "üí° Cr√©ez le secret via Rancher UI dans le namespace askme-platform"
            exit 1
          fi
          
          # Copier le secret vers le namespace client
          kubectl get secret ovh-global-dns-keys -n askme-platform -o yaml | \
            sed 's/namespace: askme-platform/namespace: {{ .Release.Namespace }}/' | \
            sed '/resourceVersion/d' | \
            sed '/uid:/d' | \
            kubectl apply -f -
          
          echo "‚úÖ Secret OVH copi√© avec succ√®s dans {{ .Release.Namespace }}"
          echo "üîç V√©rification:"
          kubectl get secret ovh-global-dns-keys -n {{ .Release.Namespace }} --no-headers || echo "‚ùå √âchec copie"
        
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi" 
            cpu: "200m"
---
# ServiceAccount pour acc√®s cross-namespace
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "askme.fullname" . }}-secret-copier
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
---
# Role pour lire le secret dans askme-platform
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: askme-platform
  name: secret-reader-{{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["ovh-global-dns-keys"]
  verbs: ["get"]
---
# Role pour cr√©er le secret dans le namespace client
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: {{ .Release.Namespace }}
  name: secret-creator-{{ .Release.Name }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "patch", "get"]
---
# RoleBinding pour lecture cross-namespace  
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-reader-{{ .Release.Namespace }}-{{ .Release.Name }}
  namespace: askme-platform
  labels:
    {{- include "askme.labels" . | nindent 4 }}
subjects:
- kind: ServiceAccount
  name: {{ include "askme.fullname" . }}-secret-copier
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: secret-reader-{{ .Release.Namespace }}
  apiGroup: rbac.authorization.k8s.io
---
# RoleBinding pour cr√©ation dans namespace client
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-creator-{{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
subjects:
- kind: ServiceAccount
  name: {{ include "askme.fullname" . }}-secret-copier
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: secret-creator-{{ .Release.Name }}
  apiGroup: rbac.authorization.k8s.io
{{- end }}