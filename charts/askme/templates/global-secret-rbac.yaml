# ServiceAccount pour accès cross-namespace aux secrets globaux
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "askme.fullname" . }}-dns-manager
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
    app.kubernetes.io/component: dns-manager
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-2"  # Créé en PREMIER
    helm.sh/hook-delete-policy: before-hook-creation
---
# Role pour lire les secrets globaux dans askme-platform
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: askme-platform
  name: global-secret-reader-{{ .Release.Namespace }}-{{ .Release.Name }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-2"  # Créé en PREMIER
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: 
    {{- if .Values.dns.ovh.enabled }}
    - "ovh-global-dns-keys"
    {{- end }}
    - "askme-tokens"
    - "harbor-keys"
  verbs: ["get"]
---
# RoleBinding pour accès cross-namespace aux secrets globaux
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: global-secret-access-{{ .Release.Namespace }}-{{ .Release.Name }}
  namespace: askme-platform
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-2"  # Créé en PREMIER
subjects:
- kind: ServiceAccount
  name: {{ include "askme.fullname" . }}-dns-manager
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: global-secret-reader-{{ .Release.Namespace }}-{{ .Release.Name }}
  apiGroup: rbac.authorization.k8s.io
---
# Role pour gérer les secrets dans le namespace local
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: {{ .Release.Namespace }}
  name: local-secret-manager-{{ .Release.Name }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-2"  # Créé en premier
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch", "apply"]
---
# RoleBinding pour gestion locale des secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: local-secret-manager-{{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-2"  # Créé en premier
subjects:
- kind: ServiceAccount
  name: {{ include "askme.fullname" . }}-dns-manager
  namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: local-secret-manager-{{ .Release.Name }}
  apiGroup: rbac.authorization.k8s.io