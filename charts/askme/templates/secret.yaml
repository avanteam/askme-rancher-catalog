apiVersion: v1
kind: Secret
metadata:
  name: askme-local-tokens
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "askme.labels" . | nindent 4 }}
  annotations:
    askme.avanteam.com/client: {{ .Release.Name }}
    askme.avanteam.com/version: {{ .Chart.AppVersion }}
    # Protection contre les suppressions lors des upgrades Helm
    helm.sh/resource-policy: keep
    # Indique que ce secret contient des tokens specifiques au client
    askme.avanteam.com/secret-type: "client-specific-tokens"
type: Opaque
stringData:
  # ===== AVANTEAM AUTH TOKEN =====
  # Source: questions.yaml -> avanteam.authToken
  {{- if .Values.avanteam.authToken }}
  AVANTEAM_AUTH_TOKEN: {{ .Values.avanteam.authToken | quote }}
  {{- end }}

  # ===== AZURE OPENAI =====
  # Source: questions.yaml -> azure.openai.key
  {{- if .Values.azure.openai.key }}
  AZURE_OPENAI_KEY: {{ .Values.azure.openai.key | quote }}
  {{- end }}

  # Source: questions.yaml -> azure.openai.embeddingKey
  {{- if .Values.azure.openai.embeddingKey }}
  AZURE_OPENAI_EMBEDDING_KEY: {{ .Values.azure.openai.embeddingKey | quote }}
  {{- end }}

  # ===== CLAUDE AI =====
  # Source: questions.yaml -> claude.apiKey
  {{- if .Values.claude.apiKey }}
  CLAUDE_API_KEY: {{ .Values.claude.apiKey | quote }}
  {{- end }}

  # ===== OPENAI DIRECT =====
  # Source: questions.yaml -> openai.apiKey
  {{- if .Values.openai.apiKey }}
  OPENAI_DIRECT_API_KEY: {{ .Values.openai.apiKey | quote }}
  {{- end }}

  # ===== MISTRAL AI =====
  # Source: questions.yaml -> mistral.apiKey
  {{- if .Values.mistral.apiKey }}
  MISTRAL_API_KEY: {{ .Values.mistral.apiKey | quote }}
  {{- end }}

  # ===== GEMINI AI =====
  # Source: questions.yaml -> gemini.apiKey
  {{- if .Values.gemini.apiKey }}
  GEMINI_API_KEY: {{ .Values.gemini.apiKey | quote }}
  {{- end }}

  # ===== AZURE SEARCH =====
  # Source: questions.yaml -> azure.search.key
  {{- if .Values.azure.search.key }}
  AZURE_SEARCH_KEY: {{ .Values.azure.search.key | quote }}
  {{- end }}

  # ===== AZURE SPEECH =====
  # Source: questions.yaml -> azure.speech.key
  {{- if .Values.azure.speech.key }}
  AZURE_SPEECH_KEY: {{ .Values.azure.speech.key | quote }}
  {{- end }}

  # ===== AZURE COSMOSDB =====
  # Source: questions.yaml -> azure.cosmosdb.key
  {{- if .Values.azure.cosmosdb.key }}
  AZURE_COSMOSDB_ACCOUNT_KEY: {{ .Values.azure.cosmosdb.key | quote }}
  {{- end }}

  # ===== EXTERNAL API =====
  # Source: questions.yaml -> externalApi.keys
  {{- if .Values.externalApi.keys }}
  EXTERNAL_API_KEYS: {{ .Values.externalApi.keys | quote }}
  {{- end }}

  # NOTE IMPORTANTE:
  # Ce secret sera complete par le job global-secret-sync.yaml
  # qui ajoutera les cles manquantes depuis le secret global 'askme-tokens@askme-platform'
  # Les cles definies ici (depuis questions.yaml) ont la priorite et ne seront pas ecrasees
  # grace a l'annotation helm.sh/resource-policy: keep
