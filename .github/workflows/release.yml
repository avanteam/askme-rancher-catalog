name: AskMe Rancher Catalog - Helm Chart Only

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - prod
  pull_request:
    branches:
      - main
      - prod
  repository_dispatch:
    types: [new-askme-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  packager (ex: 1.0.2)'
        required: true
        type: string
      app_changes:
        description: 'Changements de askme-app (optionnel)'
        required: false
        type: string

jobs:
  # ===== TESTS =====
  test:
    name: ðŸ§ª Validate Catalog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Validate Helm Chart
        run: |
          helm lint charts/askme/
          helm template test charts/askme/ --dry-run

      - name: Validate questions.yaml
        run: |
          # VÃ©rifier que questions.yaml est un YAML valide
          python -c "import yaml; yaml.safe_load(open('charts/askme/questions.yaml'))"

      - name: Validate values.yaml
        run: |
          # VÃ©rifier que values.yaml est un YAML valide
          python -c "import yaml; yaml.safe_load(open('charts/askme/values.yaml'))"

  # ===== PACKAGE HELM =====
  package:
    name: ðŸ“¦ Package Helm Chart
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'repository_dispatch' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout Catalog
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Extract Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Version manuelle depuis l'input
            VERSION="${{ github.event.inputs.version }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Manual release version: $VERSION"
          elif [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            # Version depuis le payload repository_dispatch
            VERSION="${{ github.event.client_payload.version }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Automatic release version from askme-app: $VERSION"
          elif [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Tag release version: $VERSION"
          else
            # Pour les branches, utiliser version dev avec hash
            VERSION="0.0.0-dev-${GITHUB_SHA::8}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Development version: $VERSION"
          fi

      - name: Fetch App Changes (for repository_dispatch)
        if: github.event_name == 'repository_dispatch'
        id: app_changes
        run: |
          echo "ðŸ“¡ RÃ©cupÃ©ration des changements depuis askme-app..."
          
          # RÃ©cupÃ©rer les changements depuis le payload
          APP_CHANGES="${{ github.event.client_payload.changes }}"
          
          if [[ -n "$APP_CHANGES" ]]; then
            echo "âœ… Changements reÃ§us depuis askme-app:"
            echo "$APP_CHANGES"
            
            # Ã‰chapper les caractÃ¨res spÃ©ciaux pour le JSON
            APP_CHANGES_ESCAPED=$(echo "$APP_CHANGES" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "app_changes=$APP_CHANGES_ESCAPED" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Aucun changement fourni par askme-app"
            echo "app_changes=" >> $GITHUB_OUTPUT
          fi

      - name: Fetch App Changes (for workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: manual_changes
        run: |
          echo "ðŸ“‹ Utilisation des changements manuels..."
          
          APP_CHANGES="${{ github.event.inputs.app_changes }}"
          if [[ -n "$APP_CHANGES" ]]; then
            APP_CHANGES_ESCAPED=$(echo "$APP_CHANGES" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "app_changes=$APP_CHANGES_ESCAPED" >> $GITHUB_OUTPUT
          else
            echo "app_changes=" >> $GITHUB_OUTPUT
          fi

      - name: Update Chart Version and Changes
        run: |
          echo "ðŸ“ Updating Chart.yaml with version ${{ steps.version.outputs.version }}"
          
          # RÃ©cupÃ©rer les changements selon le type d'Ã©vÃ©nement
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            NEW_CHANGES="${{ steps.app_changes.outputs.app_changes }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            NEW_CHANGES="${{ steps.manual_changes.outputs.app_changes }}"
          else
            NEW_CHANGES=""
          fi
          
          # Mise Ã  jour des versions
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" charts/askme/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" charts/askme/Chart.yaml
          
          # Mise Ã  jour des changements si on a de nouvelles informations
          if [[ -n "$NEW_CHANGES" ]]; then
            echo "ðŸ“ Mise Ã  jour des changements avec les infos de askme-app..."
            
            # Lire les changements existants
            CURRENT_CHANGES=$(yq eval '.annotations."catalog.cattle.io/changes"' charts/askme/Chart.yaml)
            
            # Construire les nouveaux changements
            NEW_VERSION_CHANGES="v${{ steps.version.outputs.version }}:"$'\n'"$NEW_CHANGES"
            
            # Combiner avec les existants
            if [[ "$CURRENT_CHANGES" != "null" ]] && [[ -n "$CURRENT_CHANGES" ]]; then
              COMBINED_CHANGES="$NEW_VERSION_CHANGES"$'\n'"$CURRENT_CHANGES"
            else
              COMBINED_CHANGES="$NEW_VERSION_CHANGES"
            fi
            
            # Appliquer les changements avec yq
            yq eval -i '.annotations."catalog.cattle.io/changes" = "'"$COMBINED_CHANGES"'"' charts/askme/Chart.yaml
            
            echo "âœ… Changements mis Ã  jour avec les infos de askme-app"
          else
            echo "ðŸ“‹ Pas de nouveaux changements Ã  ajouter"
          fi
          
          echo "âœ… Chart.yaml updated:"
          grep "^version:" charts/askme/Chart.yaml
          grep "^appVersion:" charts/askme/Chart.yaml

      - name: Update Chart Values (for releases)
        if: steps.version.outputs.is-release == 'true'
        run: |
          echo "ðŸ“ Updating values.yaml image tag for release"
          sed -i "s|tag: \".*\"|tag: \"${{ steps.version.outputs.version }}\"|" charts/askme/values.yaml
          
          echo "âœ… values.yaml updated:"
          grep "tag:" charts/askme/values.yaml

      - name: Restore All Previous Packages
        run: |
          echo "ðŸ“¦ RÃ©cupÃ©ration de TOUS les packages .tgz depuis l'historique git..."
          
          # RÃ©cupÃ©rer tous les packages .tgz depuis les commits prÃ©cÃ©dents
          git log --name-only --pretty=format: | grep '\.tgz$' | sort | uniq | while read tgz_file; do
            if [[ -n "$tgz_file" ]] && [[ ! -f "$tgz_file" ]]; then
              echo "ðŸ”„ RÃ©cupÃ©ration de $tgz_file depuis l'historique..."
              # Essayer de rÃ©cupÃ©rer le fichier depuis l'historique
              git checkout HEAD~1 -- "$tgz_file" 2>/dev/null || \
              git checkout HEAD~2 -- "$tgz_file" 2>/dev/null || \
              git checkout HEAD~3 -- "$tgz_file" 2>/dev/null || \
              git checkout HEAD~5 -- "$tgz_file" 2>/dev/null || \
              echo "âš ï¸ Impossible de rÃ©cupÃ©rer $tgz_file"
            fi
          done
          
          echo "ðŸ“‹ Packages disponibles aprÃ¨s rÃ©cupÃ©ration:"
          ls -la *.tgz 2>/dev/null || echo "Aucun package trouvÃ©"
          
          echo "ðŸ“ Contenu actuel de index.yaml:"
          if [[ -f "index.yaml" ]]; then
            echo "âœ… index.yaml trouvÃ©, versions disponibles:"
            yq eval '.entries.askme[].version' index.yaml 2>/dev/null | sort -V || echo "Erreur lors de la lecture des versions"
          else
            echo "âš ï¸ index.yaml non trouvÃ© dans le workspace"
          fi

      - name: Package Helm Chart
        run: |
          echo "ðŸ“¦ Packaging Helm chart..."
          helm package charts/askme --destination ./
          
          echo "âœ… Chart packaged:"
          ls -la *.tgz

      - name: Generate Chart Index
        run: |
          echo "ðŸ“ Generating Helm repository index with all versions..."
          
          # VÃ©rifier si index.yaml existe et contient des donnÃ©es
          if [[ -f "index.yaml" ]] && yq eval '.entries.askme | length' index.yaml > /dev/null 2>&1; then
            echo "âœ… index.yaml existant trouvÃ©, fusion avec les nouvelles versions..."
            # Merge avec l'index existant
            helm repo index . --url https://github.com/${{ github.repository }}/releases/download --merge index.yaml
          else
            echo "ðŸ†• CrÃ©ation d'un nouvel index.yaml..."
            # CrÃ©er un nouvel index
            helm repo index . --url https://github.com/${{ github.repository }}/releases/download
          fi
          
          echo "âœ… Index mis Ã  jour, versions disponibles:"
          yq eval '.entries.askme[].version' index.yaml | sort -V || echo "Erreur lors de la lecture"
          
          echo "ðŸ“Š Nombre total de versions dans le catalogue:"
          yq eval '.entries.askme | length' index.yaml || echo "Erreur lors du compte"

      - name: Upload Chart Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-${{ steps.version.outputs.version }}
          path: |
            *.tgz
            index.yaml

      - name: Update Repository Index (for releases)
        if: steps.version.outputs.is-release == 'true'
        run: |
          echo "ðŸ”„ Committing updated files for release..."
          git config user.name "AskMe Release Bot"
          git config user.email "noreply@avanteam.com"
          
          # Ajouter les fichiers modifiÃ©s + TOUS les packages
          git add charts/askme/Chart.yaml charts/askme/values.yaml index.yaml
          
          # S'assurer que TOUS les packages .tgz sont ajoutÃ©s (mÃªme s'ils existaient dÃ©jÃ )
          echo "ðŸ“¦ Ajout de tous les packages .tgz au commit:"
          ls -la *.tgz
          git add *.tgz  # Tous les packages (nouveaux et existants)
          
          # VÃ©rifier ce qui sera committÃ©
          echo "ðŸ“‹ Fichiers qui seront committÃ©s:"
          git diff --staged --name-only
          
          # Commit seulement si il y a des changements
          if git diff --staged --quiet; then
            echo "ðŸ“‹ No changes to commit"
          else
            # Message de commit adaptÃ© selon le dÃ©clencheur
            if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
              TRIGGER_INFO="Auto-triggered from askme-app release"
            elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              TRIGGER_INFO="Manual release via workflow_dispatch"
            else
              TRIGGER_INFO="Release from git tag"
            fi
            
            git commit -m "ðŸš€ Release AskMe Helm Chart v${{ steps.version.outputs.version }}

            - Updated Chart.yaml version to ${{ steps.version.outputs.version }}
            - Updated values.yaml image tag to ${{ steps.version.outputs.version }}  
            - Updated index.yaml with new chart version (preserving all previous versions)
            - Added packaged chart askme-${{ steps.version.outputs.version }}.tgz
            - $TRIGGER_INFO
            
            Ready for deployment via Rancher UI"
            
            echo "âœ… Changes committed successfully"
          fi

  # ===== RELEASE =====
  release:
    name: ðŸš€ Create GitHub Release  
    runs-on: ubuntu-latest
    needs: [test, package]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout Catalog
        uses: actions/checkout@v4

      - name: Download Chart Artifacts
        uses: actions/download-artifact@v4
        with:
          name: helm-charts-${{ needs.package.outputs.version || github.ref_name }}
          path: ./

      - name: Extract Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        run: |
          cat > release-notes.md << EOF
          ## ðŸš€ AskMe Helm Chart v${{ steps.version.outputs.version }}
          
          ### ðŸ“¦ Installation via Rancher UI
          1. **Ajouter le catalogue :** \`https://github.com/${{ github.repository }}\`
          2. **Apps & Marketplace â†’ Charts â†’ AskMe**
          3. **SÃ©lectionner version :** \`${{ steps.version.outputs.version }}\`
          4. **Configurer les paramÃ¨tres client**
          5. **Install**
          
          ### ðŸ“¦ Installation via Helm CLI
          \`\`\`bash
          # Ajouter le repository
          helm repo add askme https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/
          helm repo update
          
          # Installer AskMe
          helm install my-askme askme/askme --version ${{ steps.version.outputs.version }} \\
            --set client.name=mon-client \\
            --set client.domain=mon-client.avanteam-saas.com
          \`\`\`
          
          ### ðŸ”§ Configuration
          - **Multi-LLM** : Azure OpenAI, Claude, OpenAI Direct, Mistral, Gemini
          - **Multi-client** : Isolation namespace automatique
          - **Interface vocale** : Wake words configurables  
          - **DNS automatique** : IntÃ©gration OVH API
          - **Secrets centralisÃ©s** : Gestion unifiÃ©e des clÃ©s API
          
          ### ðŸ“‹ Fichiers de Configuration
          - [\`questions.yaml\`](https://github.com/${{ github.repository }}/blob/v${{ steps.version.outputs.version }}/charts/askme/questions.yaml) : Interface Rancher UI
          - [\`values.yaml\`](https://github.com/${{ github.repository }}/blob/v${{ steps.version.outputs.version }}/charts/askme/values.yaml) : Valeurs par dÃ©faut
          
          ### ðŸ³ Image Docker Correspondante
          \`\`\`
          7wpjr0wh.c1.gra9.container-registry.ovh.net/library/askme-app:${{ steps.version.outputs.version }}
          \`\`\`
          
          **Note:** L'image Docker est construite automatiquement par le repository [\`askme-app-aoai\`](https://github.com/avanteam/askme-app-aoai)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.tgz
            index.yaml
          body_path: release-notes.md
          generate_release_notes: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===== NOTIFICATION =====
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [test, package]
    if: always()
    steps:
      - name: Success Notification
        if: needs.test.result == 'success' && needs.package.result == 'success'
        run: |
          echo "âœ… Rancher Catalog pipeline rÃ©ussie pour ${{ github.ref_name }}"
          echo "ðŸ“¦ Chart Helm packagÃ© avec succÃ¨s"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ðŸš€ Release crÃ©Ã©e : https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
            echo "ðŸŒ Nouvelle version disponible dans Rancher UI"
          fi

      - name: Failure Notification
        if: needs.test.result == 'failure' || needs.package.result == 'failure'
        run: |
          echo "âŒ Rancher Catalog pipeline Ã©chouÃ©e pour ${{ github.ref_name }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Package: ${{ needs.package.result }}"