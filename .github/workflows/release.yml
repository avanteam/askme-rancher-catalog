name: AskMe Rancher Catalog - Helm Chart Only

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - prod
  pull_request:
    branches:
      - main
      - prod

jobs:
  # ===== TESTS =====
  test:
    name: ðŸ§ª Validate Catalog
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Validate Helm Chart
        run: |
          helm lint charts/askme/
          helm template test charts/askme/ --dry-run

      - name: Validate questions.yaml
        run: |
          # VÃ©rifier que questions.yaml est un YAML valide
          python -c "import yaml; yaml.safe_load(open('charts/askme/questions.yaml'))"

      - name: Validate values.yaml
        run: |
          # VÃ©rifier que values.yaml est un YAML valide
          python -c "import yaml; yaml.safe_load(open('charts/askme/values.yaml'))"

  # ===== PACKAGE HELM =====
  package:
    name: ðŸ“¦ Package Helm Chart
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    steps:
      - name: Checkout Catalog
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Extract Version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Release version: $VERSION"
          else
            # Pour les branches, utiliser version dev avec hash
            VERSION="0.0.0-dev-${GITHUB_SHA::8}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "ðŸ“Œ Development version: $VERSION"
          fi

      - name: Update Chart Version
        run: |
          echo "ðŸ“ Updating Chart.yaml with version ${{ steps.version.outputs.version }}"
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" charts/askme/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" charts/askme/Chart.yaml
          
          echo "âœ… Chart.yaml updated:"
          grep "^version:" charts/askme/Chart.yaml
          grep "^appVersion:" charts/askme/Chart.yaml

      - name: Update Chart Values (for releases)
        if: steps.version.outputs.is-release == 'true'
        run: |
          echo "ðŸ“ Updating values.yaml image tag for release"
          sed -i "s|tag: \".*\"|tag: \"${{ steps.version.outputs.version }}\"|" charts/askme/values.yaml
          
          echo "âœ… values.yaml updated:"
          grep "tag:" charts/askme/values.yaml

      - name: Keep Existing Packages
        run: |
          echo "ðŸ“¦ Conservation des versions existantes..."
          ls -la *.tgz 2>/dev/null || echo "Aucun package existant"
          echo "âœ… Packages existants conservÃ©s"

      - name: Package Helm Chart
        run: |
          echo "ðŸ“¦ Packaging Helm chart..."
          helm package charts/askme --destination ./
          
          echo "âœ… Chart packaged:"
          ls -la *.tgz

      - name: Generate Chart Index
        run: |
          echo "ðŸ“ Generating Helm repository index with all versions..."
          # Index avec toutes les versions (existantes + nouvelle)
          helm repo index . --url https://github.com/${{ github.repository }}/releases/download --merge index.yaml
          
          echo "âœ… Index updated with all versions:"
          grep -E "version: |appVersion: " index.yaml | head -10

      - name: Upload Chart Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts-${{ steps.version.outputs.version }}
          path: |
            *.tgz
            index.yaml

      - name: Update Repository Index (for releases)
        if: steps.version.outputs.is-release == 'true'
        run: |
          echo "ðŸ”„ Committing updated files for release..."
          git config user.name "AskMe Release Bot"
          git config user.email "noreply@avanteam.com"
          
          # Ajouter les fichiers modifiÃ©s + TOUS les packages
          git add charts/askme/Chart.yaml charts/askme/values.yaml index.yaml
          git add *.tgz  # Tous les packages (nouveaux et existants)
          
          # Commit seulement si il y a des changements
          if git diff --staged --quiet; then
            echo "ðŸ“‹ No changes to commit"
          else
            git commit -m "ðŸš€ Release AskMe Helm Chart v${{ steps.version.outputs.version }}

            - Updated Chart.yaml version to ${{ steps.version.outputs.version }}
            - Updated values.yaml image tag to ${{ steps.version.outputs.version }}  
            - Updated index.yaml with new chart version
            - Added packaged chart askme-${{ steps.version.outputs.version }}.tgz
            
            Ready for deployment via Rancher UI"
            
            echo "âœ… Changes committed successfully"
          fi

  # ===== RELEASE =====
  release:
    name: ðŸš€ Create GitHub Release  
    runs-on: ubuntu-latest
    needs: [test, package]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout Catalog
        uses: actions/checkout@v4

      - name: Download Chart Artifacts
        uses: actions/download-artifact@v4
        with:
          name: helm-charts-${{ needs.package.outputs.version || github.ref_name }}
          path: ./

      - name: Extract Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        run: |
          cat > release-notes.md << EOF
          ## ðŸš€ AskMe Helm Chart v${{ steps.version.outputs.version }}
          
          ### ðŸ“¦ Installation via Rancher UI
          1. **Ajouter le catalogue :** \`https://github.com/${{ github.repository }}\`
          2. **Apps & Marketplace â†’ Charts â†’ AskMe**
          3. **SÃ©lectionner version :** \`${{ steps.version.outputs.version }}\`
          4. **Configurer les paramÃ¨tres client**
          5. **Install**
          
          ### ðŸ“¦ Installation via Helm CLI
          \`\`\`bash
          # Ajouter le repository
          helm repo add askme https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/
          helm repo update
          
          # Installer AskMe
          helm install my-askme askme/askme --version ${{ steps.version.outputs.version }} \\
            --set client.name=mon-client \\
            --set client.domain=mon-client.avanteam-saas.com
          \`\`\`
          
          ### ðŸ”§ Configuration
          - **Multi-LLM** : Azure OpenAI, Claude, OpenAI Direct, Mistral, Gemini
          - **Multi-client** : Isolation namespace automatique
          - **Interface vocale** : Wake words configurables  
          - **DNS automatique** : IntÃ©gration OVH API
          - **Secrets centralisÃ©s** : Gestion unifiÃ©e des clÃ©s API
          
          ### ðŸ“‹ Fichiers de Configuration
          - [\`questions.yaml\`](https://github.com/${{ github.repository }}/blob/v${{ steps.version.outputs.version }}/charts/askme/questions.yaml) : Interface Rancher UI
          - [\`values.yaml\`](https://github.com/${{ github.repository }}/blob/v${{ steps.version.outputs.version }}/charts/askme/values.yaml) : Valeurs par dÃ©faut
          
          ### ðŸ³ Image Docker Correspondante
          \`\`\`
          7wpjr0wh.c1.gra9.container-registry.ovh.net/library/askme-app:${{ steps.version.outputs.version }}
          \`\`\`
          
          **Note:** L'image Docker est construite automatiquement par le repository [\`askme-app-aoai\`](https://github.com/avanteam/askme-app-aoai)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.tgz
            index.yaml
          body_path: release-notes.md
          generate_release_notes: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===== NOTIFICATION =====
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [test, package]
    if: always()
    steps:
      - name: Success Notification
        if: needs.test.result == 'success' && needs.package.result == 'success'
        run: |
          echo "âœ… Rancher Catalog pipeline rÃ©ussie pour ${{ github.ref_name }}"
          echo "ðŸ“¦ Chart Helm packagÃ© avec succÃ¨s"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ðŸš€ Release crÃ©Ã©e : https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
            echo "ðŸŒ Nouvelle version disponible dans Rancher UI"
          fi

      - name: Failure Notification
        if: needs.test.result == 'failure' || needs.package.result == 'failure'
        run: |
          echo "âŒ Rancher Catalog pipeline Ã©chouÃ©e pour ${{ github.ref_name }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Package: ${{ needs.package.result }}"